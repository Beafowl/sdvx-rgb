<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>SDVX RGB Config</title>
        <style>
            :root {
                --bg: #1a1a2e;
                --surface: #16213e;
                --surface2: #0f3460;
                --accent: #e94560;
                --text: #eee;
                --text-dim: #999;
                --border: #2a2a4a;
            }
            * {
                box-sizing: border-box;
                margin: 0;
                padding: 0;
            }
            body {
                font-family:
                    -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                    sans-serif;
                background: var(--bg);
                color: var(--text);
                padding: 20px;
                max-width: 900px;
                margin: 0 auto;
            }
            h1 {
                font-size: 1.4rem;
                margin-bottom: 4px;
            }
            .subtitle {
                color: var(--text-dim);
                font-size: 0.85rem;
                margin-bottom: 20px;
            }
            .status {
                display: inline-block;
                padding: 2px 10px;
                border-radius: 12px;
                font-size: 0.8rem;
                margin-left: 10px;
            }
            .status.ok {
                background: #1b5e20;
                color: #a5d6a7;
            }
            .status.err {
                background: #b71c1c;
                color: #ef9a9a;
            }

            /* Global section */
            .global-section {
                background: var(--surface);
                border: 1px solid var(--border);
                border-radius: 8px;
                padding: 16px;
                margin-bottom: 16px;
            }
            .global-section h2 {
                font-size: 1.1rem;
                margin-bottom: 4px;
            }
            .global-hint {
                color: var(--text-dim);
                font-size: 0.8rem;
                margin-bottom: 12px;
            }

            /* Strip cards */
            .strip-card {
                background: var(--surface);
                border: 1px solid var(--border);
                border-radius: 8px;
                padding: 16px;
                margin-bottom: 10px;
            }
            .strip-header {
                display: flex;
                align-items: center;
                gap: 12px;
                margin-bottom: 10px;
                cursor: pointer;
                user-select: none;
            }
            .strip-header h3 {
                font-size: 1rem;
                flex: 1;
            }
            .strip-toggle {
                font-size: 0.8rem;
                color: var(--text-dim);
            }
            .strip-body {
                display: none;
            }
            .strip-body.open {
                display: block;
            }

            /* Form rows */
            .field-row {
                display: flex;
                align-items: center;
                gap: 10px;
                margin-bottom: 8px;
                flex-wrap: wrap;
            }
            .field-row label {
                width: 120px;
                font-size: 0.85rem;
                color: var(--text-dim);
                flex-shrink: 0;
            }
            .field-row input[type="number"],
            .field-row input[type="text"],
            .field-row select {
                background: var(--bg);
                border: 1px solid var(--border);
                color: var(--text);
                padding: 4px 8px;
                border-radius: 4px;
                width: 120px;
                font-size: 0.85rem;
            }
            .field-row input[type="color"] {
                width: 40px;
                height: 30px;
                border: 1px solid var(--border);
                border-radius: 4px;
                padding: 1px;
                cursor: pointer;
                background: var(--bg);
            }
            .color-hex {
                font-family: monospace;
                font-size: 0.85rem;
                color: var(--text-dim);
            }
            .field-row .help {
                font-size: 0.75rem;
                color: var(--text-dim);
            }

            /* Buttons */
            .btn-row {
                display: flex;
                gap: 10px;
                margin-top: 20px;
            }
            button {
                background: var(--surface2);
                color: var(--text);
                border: 1px solid var(--border);
                padding: 8px 20px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 0.9rem;
            }
            button:hover {
                background: var(--accent);
                border-color: var(--accent);
            }
            button.primary {
                background: var(--accent);
                border-color: var(--accent);
            }
            button.primary:hover {
                background: #c1374e;
            }

            .clear-btn {
                font-size: 0.75rem;
                padding: 2px 8px;
                background: transparent;
                border: 1px solid var(--border);
                color: var(--text-dim);
            }
            .clear-btn:hover {
                color: var(--text);
                border-color: var(--accent);
                background: transparent;
            }

            /* Copy-from controls */
            .copy-row {
                display: flex;
                align-items: center;
                gap: 8px;
                margin-bottom: 10px;
                padding-bottom: 10px;
                border-bottom: 1px solid var(--border);
            }
            .copy-row label {
                font-size: 0.8rem;
                color: var(--text-dim);
            }
            .copy-row select {
                background: var(--bg);
                border: 1px solid var(--border);
                color: var(--text);
                padding: 3px 6px;
                border-radius: 4px;
                font-size: 0.8rem;
            }
            .copy-btn {
                font-size: 0.8rem;
                padding: 3px 10px;
            }
        </style>
    </head>
    <body>
        <h1>
            SDVX RGB Config
            <span id="status" class="status ok">loading...</span>
        </h1>
        <p class="subtitle">
            Edit sdvxrgb.ini via web. Changes are saved to disk and hot-reloaded
            by the hook.
        </p>

        <div id="app"></div>

        <div class="btn-row">
            <button class="primary" onclick="save()">Save</button>
            <button onclick="load()">Reload from disk</button>
        </div>

        <script>
            const STRIP_LABELS = {
                global: "Global (defaults)",
                title: "Title",
                upper_left_speaker: "Upper Left Speaker",
                upper_right_speaker: "Upper Right Speaker",
                left_wing: "Left Wing",
                right_wing: "Right Wing",
                ctrl_panel: "Control Panel",
                lower_left_speaker: "Lower Left Speaker",
                lower_right_speaker: "Lower Right Speaker",
                woofer: "Woofer",
                v_unit: "V Unit",
            };

            const CHANNEL_ORDERS = ["RGB", "RBG", "GRB", "GBR", "BRG", "BGR"];

            const FIELDS = [
                {
                    key: "channel_order",
                    label: "Channel Order",
                    type: "select",
                    options: CHANNEL_ORDERS,
                    default: "",
                },
                {
                    key: "gamma_r",
                    label: "Gamma R",
                    type: "number",
                    step: "0.1",
                    min: "0.1",
                    max: "5.0",
                    default: "",
                },
                {
                    key: "gamma_g",
                    label: "Gamma G",
                    type: "number",
                    step: "0.1",
                    min: "0.1",
                    max: "5.0",
                    default: "",
                },
                {
                    key: "gamma_b",
                    label: "Gamma B",
                    type: "number",
                    step: "0.1",
                    min: "0.1",
                    max: "5.0",
                    default: "",
                },
                {
                    key: "hue_shift",
                    label: "Hue Shift",
                    type: "number",
                    step: "1",
                    min: "0",
                    max: "359",
                    default: "",
                    help: "0-359 degrees",
                },
                {
                    key: "saturation",
                    label: "Saturation",
                    type: "number",
                    step: "1",
                    min: "0",
                    max: "200",
                    default: "",
                    help: "0-200 (100 = normal)",
                },
                {
                    key: "brightness",
                    label: "Brightness",
                    type: "number",
                    step: "1",
                    min: "0",
                    max: "200",
                    default: "",
                    help: "0-200 (100 = normal)",
                },
                {
                    key: "static_color",
                    label: "Static Color",
                    type: "color",
                    default: "",
                },
                {
                    key: "gradient_color",
                    label: "Gradient Color",
                    type: "color",
                    default: "",
                    help: "Requires static_color",
                },
            ];

            let config = {};
            let strips = [];

            function setStatus(msg, ok) {
                const el = document.getElementById("status");
                el.textContent = msg;
                el.className = "status " + (ok ? "ok" : "err");
            }

            function hexToInput(hex) {
                if (!hex) return "#000000";
                hex = hex.replace(/^#/, "");
                if (hex.length === 6) return "#" + hex.toLowerCase();
                return "#000000";
            }

            function inputToHex(val) {
                return val.replace(/^#/, "").toUpperCase();
            }

            function buildField(section, field) {
                const row = document.createElement("div");
                row.className = "field-row";

                const label = document.createElement("label");
                label.textContent = field.label;
                row.appendChild(label);

                const currentVal =
                    (config[section] && config[section][field.key]) || "";

                if (field.type === "select") {
                    const sel = document.createElement("select");
                    sel.dataset.section = section;
                    sel.dataset.key = field.key;
                    // Empty option for "not set"
                    const emptyOpt = document.createElement("option");
                    emptyOpt.value = "";
                    emptyOpt.textContent = "(default)";
                    sel.appendChild(emptyOpt);
                    for (const opt of field.options) {
                        const o = document.createElement("option");
                        o.value = opt;
                        o.textContent = opt;
                        if (currentVal.toUpperCase() === opt) o.selected = true;
                        sel.appendChild(o);
                    }
                    row.appendChild(sel);
                } else if (field.type === "color") {
                    const colorInput = document.createElement("input");
                    colorInput.type = "color";
                    colorInput.dataset.section = section;
                    colorInput.dataset.key = field.key;
                    colorInput.value = hexToInput(currentVal);
                    row.appendChild(colorInput);

                    const hexLabel = document.createElement("span");
                    hexLabel.className = "color-hex";
                    hexLabel.textContent = currentVal
                        ? currentVal.toUpperCase()
                        : "(not set)";
                    row.appendChild(hexLabel);

                    // Clear button
                    const clearBtn = document.createElement("button");
                    clearBtn.className = "clear-btn";
                    clearBtn.textContent = currentVal ? "clear" : "enable";
                    clearBtn.type = "button";
                    row.appendChild(clearBtn);

                    // Track enabled state
                    colorInput._enabled = !!currentVal;

                    colorInput.addEventListener("input", () => {
                        colorInput._enabled = true;
                        hexLabel.textContent = inputToHex(colorInput.value);
                        clearBtn.textContent = "clear";
                    });
                    clearBtn.addEventListener("click", () => {
                        if (colorInput._enabled) {
                            colorInput._enabled = false;
                            hexLabel.textContent = "(not set)";
                            clearBtn.textContent = "enable";
                        } else {
                            colorInput._enabled = true;
                            hexLabel.textContent = inputToHex(colorInput.value);
                            clearBtn.textContent = "clear";
                        }
                    });
                } else {
                    const input = document.createElement("input");
                    input.type = field.type;
                    input.dataset.section = section;
                    input.dataset.key = field.key;
                    if (field.step) input.step = field.step;
                    if (field.min) input.min = field.min;
                    if (field.max) input.max = field.max;
                    input.value = currentVal;
                    input.placeholder = "(default)";
                    row.appendChild(input);
                }

                if (field.help) {
                    const help = document.createElement("span");
                    help.className = "help";
                    help.textContent = field.help;
                    row.appendChild(help);
                }

                return row;
            }

            function readSectionValues(section) {
                const values = {};
                document
                    .querySelectorAll(`[data-section="${section}"][data-key]`)
                    .forEach((el) => {
                        const key = el.dataset.key;
                        if (el.type === "color") {
                            values[key] = {
                                type: "color",
                                enabled: !!el._enabled,
                                value: el.value,
                            };
                        } else {
                            values[key] = {
                                type:
                                    el.tagName === "SELECT"
                                        ? "select"
                                        : "input",
                                value: el.value,
                            };
                        }
                    });
                return values;
            }

            function writeSectionValues(section, values) {
                document
                    .querySelectorAll(`[data-section="${section}"][data-key]`)
                    .forEach((el) => {
                        const key = el.dataset.key;
                        const src = values[key];
                        if (!src) return;

                        if (el.type === "color" && src.type === "color") {
                            el.value = src.value;
                            el._enabled = src.enabled;
                            const row = el.closest(".field-row");
                            const hexLabel = row.querySelector(".color-hex");
                            const clearBtn = row.querySelector(".clear-btn");
                            if (src.enabled) {
                                hexLabel.textContent = inputToHex(src.value);
                                clearBtn.textContent = "clear";
                            } else {
                                hexLabel.textContent = "(not set)";
                                clearBtn.textContent = "enable";
                            }
                        } else {
                            el.value = src.value;
                        }
                    });
            }

            function buildCopyRow(section) {
                const row = document.createElement("div");
                row.className = "copy-row";

                const lbl = document.createElement("label");
                lbl.textContent = "Copy from:";
                row.appendChild(lbl);

                const sel = document.createElement("select");
                const emptyOpt = document.createElement("option");
                emptyOpt.value = "";
                emptyOpt.textContent = "-- select --";
                sel.appendChild(emptyOpt);

                const sources = [
                    "global",
                    ...strips.filter((s) => s !== section),
                ];
                for (const src of sources) {
                    const o = document.createElement("option");
                    o.value = src;
                    o.textContent = STRIP_LABELS[src] || src;
                    sel.appendChild(o);
                }
                row.appendChild(sel);

                const btn = document.createElement("button");
                btn.type = "button";
                btn.className = "copy-btn";
                btn.textContent = "Copy";
                btn.addEventListener("click", () => {
                    const src = sel.value;
                    if (!src) return;
                    writeSectionValues(section, readSectionValues(src));
                    sel.value = "";
                });
                row.appendChild(btn);

                return row;
            }

            function buildSection(section, isGlobal) {
                const card = document.createElement("div");
                card.className = isGlobal ? "global-section" : "strip-card";

                const header = document.createElement("div");
                header.className = "strip-header";

                const h = document.createElement(isGlobal ? "h2" : "h3");
                h.textContent = STRIP_LABELS[section] || section;
                header.appendChild(h);

                if (!isGlobal) {
                    const toggle = document.createElement("span");
                    toggle.className = "strip-toggle";
                    toggle.textContent = "expand";
                    header.appendChild(toggle);
                }

                card.appendChild(header);

                if (isGlobal) {
                    const hint = document.createElement("div");
                    hint.className = "global-hint";
                    hint.textContent =
                        "Values here apply to all strips unless overridden per-strip.";
                    card.appendChild(hint);
                }

                const body = document.createElement("div");
                body.className = "strip-body" + (isGlobal ? " open" : "");

                if (!isGlobal) {
                    body.appendChild(buildCopyRow(section));
                }

                for (const field of FIELDS) {
                    body.appendChild(buildField(section, field));
                }

                card.appendChild(body);

                if (!isGlobal) {
                    header.addEventListener("click", () => {
                        const open = body.classList.toggle("open");
                        header.querySelector(".strip-toggle").textContent = open
                            ? "collapse"
                            : "expand";
                    });
                }

                return card;
            }

            function render() {
                const app = document.getElementById("app");
                app.innerHTML = "";

                // Global section
                app.appendChild(buildSection("global", true));

                // Per-strip sections
                for (const name of strips) {
                    app.appendChild(buildSection(name, false));
                }
            }

            function gatherConfig() {
                const data = {};
                const allSections = ["global", ...strips];

                for (const section of allSections) {
                    data[section] = {};
                }

                // Gather from inputs
                document
                    .querySelectorAll("[data-section][data-key]")
                    .forEach((el) => {
                        const section = el.dataset.section;
                        const key = el.dataset.key;
                        if (!data[section]) data[section] = {};

                        if (el.type === "color") {
                            data[section][key] = el._enabled
                                ? inputToHex(el.value)
                                : "";
                        } else {
                            data[section][key] = el.value;
                        }
                    });

                return data;
            }

            async function save() {
                const data = gatherConfig();
                try {
                    const res = await fetch("/api/config", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(data),
                    });
                    const json = await res.json();
                    if (json.ok) {
                        setStatus("saved", true);
                    } else {
                        setStatus("error: " + (json.error || "unknown"), false);
                    }
                } catch (e) {
                    setStatus("save failed: " + e.message, false);
                }
            }

            async function load() {
                try {
                    const res = await fetch("/api/config");
                    const json = await res.json();
                    strips = json.strips;
                    config = json.config;
                    render();
                    setStatus("loaded", true);
                } catch (e) {
                    setStatus("load failed: " + e.message, false);
                }
            }

            // Initial load
            load();
        </script>
    </body>
</html>
